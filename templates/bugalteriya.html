{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto mt-6">
    <h1 class="text-2xl font-bold mb-6">Bugalteriya</h1>
    
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-300">
            <thead>
                <tr class="bg-gray-100">
                    <th class="px-4 py-2 border">Mijoz</th>
                    <th class="px-4 py-2 border">GPS ID</th>
                    {% for oy in oylar %}
                    <th class="px-4 py-2 border" colspan="2">{{ oy }}</th>
                    {% endfor %}
                </tr>
                <tr class="bg-gray-50">
                    <th colspan="2"></th>
                    {% for _ in oylar %}
                    <th class="px-2 py-1 border text-sm">Abonent</th>
                    <th class="px-2 py-1 border text-sm">SIM</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for sotish in sotish_data %}
                    {% for gps_item in sotish.gps_data %}
                        <tr class="hover:bg-gray-50">
                            {% if forloop.first %}
                            <td class="px-4 py-2 border" rowspan="{{ sotish.gps_data|length }}">
                                {{ sotish.sotish.mijoz }}
                            </td>
                            {% endif %}
                            <td class="px-4 py-2 border">{{ gps_item.gps.gps_id }}</td>
                            {% for tolov in gps_item.oylar %}
                                <td class="px-2 py-1 border text-center">
                                    <form method="post" action="{% url 'bugalteriya_update' tolov.id %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="abonent_tolov" value="1">
                                        <button type="submit" 
                                                class="w-8 h-8 rounded-full text-center hover:bg-gray-100 flex items-center justify-center focus:outline-none">
                                            {% if tolov.abonent_tolov %}
                                            <span class="text-xl text-center text-green-500">✅</span>
                                            {% else %}
                                            <span class="text-xl text-red-500">❌</span>
                                            {% endif %}
                                        </button>
                                    </form>
                                </td>
                                <td class="px-2 py-1 border text-center">
                                    <form method="post" action="{% url 'bugalteriya_update' tolov.id %}" class="inline text-center">
                                        {% csrf_token %}
                                        <input type="hidden" name="sim_karta_tolov" value="1">
                                        <button type="submit" 
                                                class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center focus:outline-none">
                                            {% if tolov.sim_karta_tolov %}
                                            <span class="text-xl text-green-500">✅</span>
                                            {% else %}
                                            <span class="text-xl text-red-500">❌</span>
                                            {% endif %}
                                        </button>
                                    </form>
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const button = form.querySelector('button');
            const span = button.querySelector('span');
            
            // Agar belgilangan va foydalanuvchi superuser bo'lmasa, o'zgartirmaslik
            if (span.textContent === '✅' && !{{ request.user.is_superuser|yesno:"true,false" }}) {
                alert("Faqat superuser to'lovni qayta o'zgartira oladi!");
                return;
            }
            
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: new FormData(form)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // To'lov holatini o'zgartirish
                    if (span.textContent === '❌') {
                        span.textContent = '✅';
                        span.classList.remove('text-red-500');
                        span.classList.add('text-green-500');
                    } else {
                        span.textContent = '❌';
                        span.classList.remove('text-green-500');
                        span.classList.add('text-red-500');
                    }
                } else {
                    alert(data.message || 'Xatolik yuz berdi!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Xatolik yuz berdi!');
            });
        });
    });
});
</script>
{% endblock %}