{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto mt-6">
    <div class="mb-4">
        <a href="{% url 'sotish_list' %}" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Orqaga</a>
    </div>

    <form method="POST" class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
            {% csrf_token %}
    
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Mijoz</label>
            {{ form.mijoz }}
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Telefon raqam</label>
            {{ form.mijoz_tel_raqam }}
                    </div>
        
        <div id="gps-container">
            {% for gps, sim in zip_gps_sim %}
            <div class="mb-4 flex items-center gap-4">
                <div class="flex-grow">
                    <label class="block text-gray-700 font-medium mb-2">GPS ID</label>
                    <select name="gps_id" onchange="updateDisabledOptions()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">GPS tanlang</option>
                        {% for g in mavjud_gpslar %}
                            <option value="{{ g.id }}" {% if g.id == gps.id %}selected{% endif %}>{{ g.gps_id }}</option>
                        {% endfor %}
                    </select>
                    </div>
                <div class="flex-grow">
                    <label class="block text-gray-700 font-medium mb-2">SIM karta</label>
                    <input type="text" name="sim_karta" value="{{ sim }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <button type="button" onclick="removeGpsField(this)" class="mt-6 bg-red-500 text-white py-2 px-4 rounded-lg">
                    -
                            </button>
                        </div>
            {% endfor %}
                    </div>
        
        <button type="button" onclick="addGpsField()" class="mb-4 bg-green-500 text-white py-2 px-4 rounded-lg">
            + GPS qo'shish
        </button>

        <!-- Qolgan maydonlar -->
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Dasturiy ta'minot</label>
            {{ form.dasturiy_taminot }}
                    </div>

        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Username</label>
            {{ form.username }}
                </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Password</label>
            {{ form.password }}
                    </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Abonent to'lov</label>
            {{ form.abonent_tulov }}
                    </div>

        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Sana</label>
            {{ form.sana }}
                </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Umumiy summa</label>
            {{ form.summasi }}
                    </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Naqd</label>
            {{ form.naqd }}
                    </div>

        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Bank hisob</label>
            {{ form.bank_schot }}
                </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Karta</label>
            {{ form.karta }}
                    </div>
                
        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Master</label>
            {{ form.master }}
                        </div>

        <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">Master summasi</label>
            {{ form.master_summasi }}
                </div>
        
        <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg">
                        Saqlash
                    </button>
    </form>
                </div>

            <script>
function updateDisabledOptions() {
    const container = document.getElementById('gps-container');
    const selects = container.querySelectorAll('select[name="gps_id"]');
    
    // Har bir select uchun tanlangan qiymatlarni yig'ish
    const selectedValues = new Map();
    selects.forEach(select => {
        if (select.value) {
            selectedValues.set(select.value, select);
        }
    });

    // Har bir select uchun optionlarni yangilash
    selects.forEach(currentSelect => {
        Array.from(currentSelect.options).forEach(option => {
            if (option.value === "") return; // "GPS tanlang" opsiyasini o'tkazib yuborish

            const selectWithValue = selectedValues.get(option.value);
            if (selectWithValue) {
                // Agar bu option qayerdadir tanlangan bo'lsa
                if (selectWithValue === currentSelect) {
                    // Agar aynan shu selectda tanlangan bo'lsa
                    option.hidden = true;
                    option.disabled = false;
                    if (option.value === currentSelect.value) {
                        option.hidden = false; // Tanlangan qiymatni ko'rsatish
                    }
                } else {
                    // Agar boshqa selectda tanlangan bo'lsa
                    option.disabled = true;
                    option.hidden = false;
                }
            } else {
                // Agar hech qayerda tanlanmagan bo'lsa
                option.disabled = false;
                option.hidden = false;
            }
        });
    });
}

function addGpsField() {
    const container = document.getElementById('gps-container');
    const newField = document.createElement('div');
    newField.className = 'mb-4 flex items-center gap-4';
    
    newField.innerHTML = `
        <div class="flex-grow">
            <label class="block text-gray-700 font-medium mb-2">GPS ID</label>
            <select name="gps_id" onchange="updateDisabledOptions()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">GPS tanlang</option>
                {% for g in mavjud_gpslar %}
                    <option value="{{ g.id }}">{{ g.gps_id }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex-grow">
            <label class="block text-gray-700 font-medium mb-2">SIM karta</label>
            <input type="text" name="sim_karta" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <button type="button" onclick="removeGpsField(this)" class="mt-6 bg-red-500 text-white py-2 px-4 rounded-lg">
                            -
                        </button>
                    `;
    
    container.appendChild(newField);
    updateDisabledOptions();
}

function removeGpsField(button) {
    button.closest('.mb-4').remove();
    updateDisabledOptions();
}

document.addEventListener("DOMContentLoaded", function () {
    updateDisabledOptions();
});
            </script>
{% endblock %}